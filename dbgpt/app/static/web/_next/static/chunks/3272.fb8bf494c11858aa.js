"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3272],{51310:function(e,l,t){var n=t(88506);l.Z=()=>{var e;return JSON.parse(null!==(e=localStorage.getItem(n.C9))&&void 0!==e?e:"")}},54865:function(e,l,t){t.r(l),t.d(l,{default:function(){return X}});var n=t(96469),s=t(45277),a=t(40789),i=t(2242),r=t(88506),c=t(50898),o=t(53375),d=t(18197),u=t(1565),m=t(80844),x=t(58064),p=t(26869),v=t.n(p),f=t(23852),g=t.n(f),h=t(45875),j=t(38497),y=t(56841),w=t(55457),_=t(24113),b=t(82857),k=t(67153),N=t(40371),Z=t(95838),C=t(86250),S=t(6319),P=t(75148),O=t(74865),J=t(26953),$=t(78692),I=t(93486),M=t.n(I);let A=e=>{let{list:l,loading:t,feedback:s,setFeedbackOpen:a}=e,{t:i}=(0,y.$G)(),[r,c]=(0,j.useState)([]),[o,d]=(0,j.useState)("");return(0,n.jsxs)("div",{className:"flex flex-col",children:[(0,n.jsx)("div",{className:"flex flex-1 flex-wrap w-72",children:null==l?void 0:l.map(e=>{let l=r.findIndex(l=>l.reason_type===e.reason_type)>-1;return(0,n.jsx)(C.Z,{className:"text-xs text-[#525964] mb-2 p-1 px-2 rounded-md cursor-pointer ".concat(l?"border-[#0c75fc] text-[#0c75fc]":""),onClick:()=>{c(l=>{let t=l.findIndex(l=>l.reason_type===e.reason_type);return t>-1?[...l.slice(0,t),...l.slice(t+1)]:[...l,e]})},children:e.reason},e.reason_type)})}),(0,n.jsx)(S.default.TextArea,{placeholder:i("feedback_tip"),className:"w-64 h-20 resize-none mb-2",value:o,onChange:e=>d(e.target.value.trim())}),(0,n.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,n.jsx)(P.ZP,{className:"w-16 h-8",onClick:()=>{a(!1)},children:"取消"}),(0,n.jsx)(P.ZP,{type:"primary",className:"min-w-16 h-8",onClick:async()=>{let e=r.map(e=>e.reason_type);await (null==s?void 0:s({feedback_type:"unlike",reason_types:e,remark:o}))},loading:t,children:"确认"})]})]})};var E=e=>{var l,t;let{content:s}=e,{t:i}=(0,y.$G)(),r=(0,h.useSearchParams)(),c=null!==(t=null==r?void 0:r.get("id"))&&void 0!==t?t:"",[o,d]=O.ZP.useMessage(),[u,m]=(0,j.useState)(!1),[x,p]=(0,j.useState)(null==s?void 0:null===(l=s.feedback)||void 0===l?void 0:l.feedback_type),[f,g]=(0,j.useState)(),w=async e=>{let l=null==e?void 0:e.replace(/\trelations:.*/g,""),t=M()(l);t?l?o.open({type:"success",content:i("copy_success")}):o.open({type:"warning",content:i("copy_nothing")}):o.open({type:"error",content:i("copy_failed")})},{run:_,loading:C}=(0,Z.Z)(async e=>await (0,a.Vx)((0,a.zx)({conv_uid:c,message_id:s.order+"",feedback_type:e.feedback_type,reason_types:e.reason_types,remark:e.remark})),{manual:!0,onSuccess:e=>{let[,l]=e;p(null==l?void 0:l.feedback_type),O.ZP.success("反馈成功"),m(!1)}}),{run:S}=(0,Z.Z)(async()=>await (0,a.Vx)((0,a.Jr)()),{manual:!0,onSuccess:e=>{let[,l]=e;g(l||[]),l&&m(!0)}}),{run:P}=(0,Z.Z)(async()=>await (0,a.Vx)((0,a.Ir)({conv_uid:c,message_id:(null==s?void 0:s.order)+""})),{manual:!0,onSuccess:e=>{let[,l]=e;l&&(p("none"),O.ZP.success("操作成功"))}});return(0,n.jsxs)(n.Fragment,{children:[d,(0,n.jsxs)("div",{className:"flex flex-1 items-center text-sm px-4",children:[(0,n.jsxs)("div",{className:"flex gap-3",children:[(0,n.jsx)(b.Z,{className:v()("cursor-pointer",{"text-[#0C75FC]":"like"===x}),onClick:async()=>{if("like"===x){await P();return}await _({feedback_type:"like"})}}),(0,n.jsx)(J.Z,{placement:"bottom",autoAdjustOverflow:!0,destroyTooltipOnHide:!0,content:(0,n.jsx)(A,{setFeedbackOpen:m,feedback:_,list:f||[],loading:C}),trigger:"click",open:u,children:(0,n.jsx)(k.Z,{className:v()("cursor-pointer",{"text-[#0C75FC]":"unlike"===x}),onClick:async()=>{if("unlike"===x){await P();return}await S()}})})]}),(0,n.jsx)($.Z,{type:"vertical"}),(0,n.jsx)(N.Z,{className:"cursor-pointer",onClick:()=>w(s.context)})]})]})},F=t(57232),T=t(67661),V=t(61977),G=(0,j.memo)(e=>{var l;let{model:t}=e,s=(0,h.useSearchParams)(),a=null!==(l=null==s?void 0:s.get("scene"))&&void 0!==l?l:"";return"chat_agent"===a?(0,n.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-full bg-white dark:bg-[rgba(255,255,255,0.16)]",children:(0,n.jsx)(T.Z,{scene:a})}):t?(0,n.jsx)(V.Z,{width:32,height:32,model:t}):(0,n.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-full bg-white dark:bg-[rgba(255,255,255,0.16)]",children:(0,n.jsx)(F.Z,{})})});let z=()=>{var e;let l=JSON.parse(null!==(e=localStorage.getItem(r.C9))&&void 0!==e?e:"");return l.avatar_url?(0,n.jsx)(g(),{className:"rounded-full border border-gray-200 object-contain bg-white inline-block",width:32,height:32,src:null==l?void 0:l.avatar_url,alt:null==l?void 0:l.nick_name}):(0,n.jsx)("div",{className:"flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-tr from-[#31afff] to-[#1677ff] text-xs text-white",children:null==l?void 0:l.nick_name})},B={todo:{bgClass:"bg-gray-500",icon:(0,n.jsx)(c.Z,{className:"ml-2"})},runing:{bgClass:"bg-blue-500",icon:(0,n.jsx)(o.Z,{className:"ml-2"})},failed:{bgClass:"bg-red-500",icon:(0,n.jsx)(d.Z,{className:"ml-2"})},completed:{bgClass:"bg-green-500",icon:(0,n.jsx)(u.Z,{className:"ml-2"})}},D=e=>e.replaceAll("\\n","\n").replace(/<table(\w*=[^>]+)>/gi,"<table $1>").replace(/<tr(\w*=[^>]+)>/gi,"<tr $1>"),H=e=>null==e?void 0:e.replace(/<table(\w*=[^>]+)>/gi,"<table $1>").replace(/<tr(\w*=[^>]+)>/gi,"<tr $1>");var L=(0,j.memo)(e=>{var l;let{content:t,onLinkClick:s}=e,{t:a}=(0,y.$G)(),r=(0,h.useSearchParams)(),c=null!==(l=null==r?void 0:r.get("scene"))&&void 0!==l?l:"",{context:o,model_name:d,role:u,thinking:p}=t,f=(0,j.useMemo)(()=>"view"===u,[u]),{value:g,cachePluginContext:b}=(0,j.useMemo)(()=>{if("string"!=typeof o)return{relations:[],value:"",cachePluginContext:[]};let[e,l]=o.split("	relations:"),t=l?l.split(","):[],n=[],s=0,a=e.replace(/<dbgpt-view[^>]*>[^<]*<\/dbgpt-view>/gi,e=>{try{var l;let t=e.replaceAll("\n","\\n").replace(/<[^>]*>|<\/[^>]*>/gm,""),a=JSON.parse(t),i="<custom-view>".concat(s,"</custom-view>");return n.push({...a,result:D(null!==(l=a.result)&&void 0!==l?l:"")}),s++,i}catch(l){return console.log(l.message,l),e}});return{relations:t,cachePluginContext:n,value:a}},[o]),k=(0,j.useMemo)(()=>({"custom-view"(e){var l;let{children:t}=e,s=+t.toString();if(!b[s])return t;let{name:a,status:r,err_msg:c,result:o}=b[s],{bgClass:d,icon:u}=null!==(l=B[r])&&void 0!==l?l:{};return(0,n.jsxs)("div",{className:"bg-white dark:bg-[#212121] rounded-lg overflow-hidden my-2 flex flex-col lg:max-w-[80%]",children:[(0,n.jsxs)("div",{className:v()("flex px-4 md:px-6 py-2 items-center text-white text-sm",d),children:[a,u]}),o?(0,n.jsx)("div",{className:"px-4 md:px-6 py-4 text-sm",children:(0,n.jsx)(x.Z,{components:i.Z,rehypePlugins:[w.Z],remarkPlugins:[_.Z],children:null!=o?o:""})}):(0,n.jsx)("div",{className:"px-4 md:px-6 py-4 text-sm",children:c})]})}}),[b]);return(0,n.jsxs)("div",{className:"flex flex-1 gap-3 mt-6",children:[(0,n.jsx)("div",{className:"flex flex-shrink-0 items-start",children:f?(0,n.jsx)(G,{model:d}):(0,n.jsx)(z,{})}),(0,n.jsxs)("div",{className:"flex ".concat("chat_agent"!==c||p?"":"flex-1"," overflow-hidden"),children:[!f&&(0,n.jsx)("div",{className:"flex flex-1 items-center text-sm text-[#1c2533] dark:text-white",children:"string"==typeof o&&o}),f&&(0,n.jsxs)("div",{className:"flex flex-1 flex-col w-full",children:[(0,n.jsxs)("div",{className:"bg-white dark:bg-[rgba(255,255,255,0.16)] p-4 rounded-2xl rounded-tl-none mb-2",children:["object"==typeof o&&(0,n.jsxs)("div",{children:["[".concat(o.template_name,"]: "),(0,n.jsxs)("span",{className:"text-theme-primary cursor-pointer",onClick:s,children:[(0,n.jsx)(m.Z,{className:"mr-1"}),o.template_introduce||"More Details"]})]}),"string"==typeof o&&"chat_agent"===c&&(0,n.jsx)(x.Z,{components:{...i.Z},rehypePlugins:[w.Z],remarkPlugins:[_.Z],children:H(g)}),"string"==typeof o&&"chat_agent"!==c&&(0,n.jsx)("div",{children:(0,n.jsx)(x.Z,{components:{...i.Z,...k},rehypePlugins:[w.Z],remarkPlugins:[_.Z],children:D(g)})}),p&&!o&&(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("span",{className:"flex text-sm text-[#1c2533] dark:text-white",children:a("thinking")}),(0,n.jsxs)("div",{className:"flex",children:[(0,n.jsx)("div",{className:"w-1 h-1 rounded-full mx-1 animate-pulse1"}),(0,n.jsx)("div",{className:"w-1 h-1 rounded-full mx-1 animate-pulse2"}),(0,n.jsx)("div",{className:"w-1 h-1 rounded-full mx-1 animate-pulse3"})]})]})]}),(0,n.jsx)(E,{content:t})]})]})]})}),R=t(95859),U=t(7289),q=t(40144),K=t(35569),Q=t(44766),W=t(29828),X=()=>{var e,l;let t=(0,j.useRef)(null),i=(0,h.useSearchParams)(),r=null!==(l=null==i?void 0:i.get("id"))&&void 0!==l?l:"",{currentDialogInfo:c,model:o}=(0,j.useContext)(s.p),{history:d,handleChat:u,refreshDialogList:m,setAppInfo:x,setModelValue:p,setTemperatureValue:v,setMaxNewTokensValue:f,setResourceValue:g}=(0,j.useContext)(R.ChatContentContext),[y,w]=(0,j.useState)(!1),[_,b]=(0,j.useState)(""),k=(0,j.useMemo)(()=>{let e=(0,Q.cloneDeep)(d);return e.filter(e=>["view","human"].includes(e.role)).map(e=>({...e,key:(0,W.Z)()}))},[d]);return(0,q.Z)(async()=>{let e=(0,U.a_)();if(e&&e.id===r){let[,r]=await (0,a.Vx)((0,a.BN)({...c}));if(r){var l,t,n,s,i,d,h,j,y;let a=(null==r?void 0:null===(l=r.param_need)||void 0===l?void 0:l.map(e=>e.type))||[],c=(null===(t=null==r?void 0:null===(n=r.param_need)||void 0===n?void 0:n.filter(e=>"model"===e.type)[0])||void 0===t?void 0:t.value)||o,w=(null===(s=null==r?void 0:null===(i=r.param_need)||void 0===i?void 0:i.filter(e=>"temperature"===e.type)[0])||void 0===s?void 0:s.value)||.5,_=(null===(d=null==r?void 0:null===(h=r.param_need)||void 0===h?void 0:h.filter(e=>"max_new_tokens"===e.type)[0])||void 0===d?void 0:d.value)||2048,b=null===(j=null==r?void 0:null===(y=r.param_need)||void 0===y?void 0:y.filter(e=>"resource"===e.type)[0])||void 0===j?void 0:j.bind_value;x(r||{}),v(w||.5),f(_||2048),p(c),g(b),await u(e.message,{app_code:null==r?void 0:r.app_code,model_name:c,...(null==a?void 0:a.includes("temperature"))&&{temperature:w},...(null==a?void 0:a.includes("max_new_tokens"))&&{max_new_tokens:_},...a.includes("resource")&&{select_param:"string"==typeof b?b:JSON.stringify(b)}}),await m(),localStorage.removeItem(U.rU)}}},[r,c]),(0,j.useEffect)(()=>{setTimeout(()=>{var e,l;null===(e=t.current)||void 0===e||e.scrollTo(0,null===(l=t.current)||void 0===l?void 0:l.scrollHeight)},50)},[d,null===(e=d[d.length-1])||void 0===e?void 0:e.context]),(0,n.jsxs)("div",{className:"flex flex-col w-5/6 mx-auto",ref:t,children:[!!k.length&&k.map((e,l)=>(0,n.jsx)(L,{content:e,onLinkClick:()=>{w(!0),b(JSON.stringify(null==e?void 0:e.context,null,2))}},l)),(0,n.jsx)(K.default,{title:"JSON Editor",open:y,width:"60%",cancelButtonProps:{hidden:!0},onOk:()=>{w(!1)},onCancel:()=>{w(!1)}})]})}}}]);